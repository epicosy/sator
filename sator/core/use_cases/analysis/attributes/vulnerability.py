from sator.core.models.vulnerability.locator import VulnerabilityLocator
from sator.core.models.vulnerability.attributes import VulnerabilityAttributes

from sator.core.ports.driven.repositories.product import ProductRepositoryPort
from sator.core.ports.driven.persistence.storage import StoragePersistencePort
from sator.core.ports.driving.analysis.attributes.vulnerability import VulnerabilityAttributesAnalysisPort


class VulnerabilityAttributesAnalysis(VulnerabilityAttributesAnalysisPort):
    def __init__(self, product_repository: ProductRepositoryPort, storage_port: StoragePersistencePort):
        self.product_repository = product_repository
        self.storage_port = storage_port

    def analyze_vulnerability_attributes(self, vulnerability_id: str) -> VulnerabilityLocator | None:
        locator = self.storage_port.load(VulnerabilityLocator, vulnerability_id)

        if locator:
            return locator

        attributes = self.storage_port.load(VulnerabilityAttributes, vulnerability_id)

        if attributes:
            if attributes.product:
                products = self.product_repository.search(
                    vendor_name=attributes.vendor, product_name=attributes.product
                )

                if products:
                    # TODO: Implement a port to select the most appropriate product
                    product = products[0]
                    version = self.product_repository.get_version(product, attributes.version)

                    # TODO: validate if file name is a valid path
                    locator = VulnerabilityLocator(
                        product=product, version=version, function=attributes.function, file=attributes.file
                    )

                    self.storage_port.save(locator, vulnerability_id)
                    return locator

        return None
