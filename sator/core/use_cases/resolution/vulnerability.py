from typing import List

from sator.core.models.vulnerability import VulnerabilityMetadata, VulnerabilityDescription

from sator.core.ports.driven.gateways.oss import OSSGatewayPort
from sator.core.ports.driven.persistence.storage import StoragePersistencePort
from sator.core.ports.driven.repositories.vulnerability import VulnerabilityRepositoryPort
from sator.core.ports.driving.resolution.vulnerability import VulnerabilityResolutionPort


class VulnerabilityResolutionUseCase(VulnerabilityResolutionPort):
    def __init__(self, repository_ports: List[VulnerabilityRepositoryPort], storage_port: StoragePersistencePort,
                 oss_port: OSSGatewayPort):
        self.repository_ports = repository_ports
        self.storage_port = storage_port
        self.oss_port = oss_port

    def get_metadata(self, vulnerability_id: str) -> VulnerabilityMetadata | None:
        vulnerability = self.storage_port.load(VulnerabilityMetadata, vulnerability_id)

        if vulnerability and isinstance(vulnerability, VulnerabilityMetadata):
            return vulnerability

        #  TODO: should consider all metadata and not just the first one
        for port in self.repository_ports:
            vulnerability = port.get_metadata(vulnerability_id)
            self.storage_port.save(vulnerability, vulnerability_id)

            if vulnerability:
                return vulnerability

        return None

    def get_description(self, vulnerability_id: str) -> VulnerabilityDescription | None:
        description = self.storage_port.load(VulnerabilityDescription, vulnerability_id)

        if description:
            return description

        #  TODO: should consider all descriptions and not just the first one
        for port in self.repository_ports:
            description = port.get_description(vulnerability_id)

            if description:
                self.storage_port.save(description, vulnerability_id)

                return description

        return None
