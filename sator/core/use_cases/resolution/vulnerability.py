from typing import List

from sator.core.models.product import AffectedProducts
from sator.core.models.vulnerability import Vulnerability

from sator.core.ports.driven.persistence.storage import StoragePersistencePort
from sator.core.ports.driven.repositories.vulnerability import VulnerabilityRepositoryPort
from sator.core.ports.driving.resolution.vulnerability import VulnerabilityResolutionPort


class VulnerabilityResolutionUseCase(VulnerabilityResolutionPort):
    def __init__(self, repository_ports: List[VulnerabilityRepositoryPort], storage_port: StoragePersistencePort):
        self.repository_ports = repository_ports
        self.storage_port = storage_port

    def get_vulnerability(self, vulnerability_id: str) -> Vulnerability | None:
        vulnerability = self.storage_port.load(Vulnerability, vulnerability_id)

        if vulnerability and isinstance(vulnerability, Vulnerability):
            return vulnerability

        for port in self.repository_ports:
            vulnerability = port.get_vulnerability(vulnerability_id)

            self.storage_port.save(vulnerability, vulnerability_id)

            if vulnerability:
                return vulnerability

        return None

    def get_affected_products(self, vulnerability_id: str) -> AffectedProducts | None:
        affected_products = self.storage_port.load(AffectedProducts, vulnerability_id)

        if affected_products:
            return affected_products

        vulnerability = self.storage_port.load(Vulnerability, vulnerability_id)

        if vulnerability:
            products = [_p for port in self.repository_ports for _p in port.get_affected_products(vulnerability)]

            if products:
                affected_products = AffectedProducts(vulnerability_id=vulnerability_id, products=products)
                self.storage_port.save(affected_products, vulnerability_id)

                return affected_products

        return None

    def get_vulnerabilities(self):
        # TODO: Implement this method
        pass
