from typing import List

from sator.core.models.product import Product
from sator.core.models.vulnerability import Vulnerability

from sator.core.ports.driven.persistence.storage import StoragePersistencePort
from sator.core.ports.driven.repositories.vulnerability import VulnerabilityRepositoryPort
from sator.core.ports.driving.resolution.vulnerability import VulnerabilityResolutionPort


class VulnerabilityResolutionUseCase(VulnerabilityResolutionPort):
    def __init__(self, repository_ports: List[VulnerabilityRepositoryPort], storage_port: StoragePersistencePort):
        self.repository_ports = repository_ports
        self.storage_port = storage_port

    def get_vulnerability(self, vulnerability_id: str) -> Vulnerability | None:
        vulnerability = self.storage_port.load(Vulnerability, vulnerability_id)

        if vulnerability and isinstance(vulnerability, Vulnerability):
            return vulnerability

        for port in self.repository_ports:
            vulnerability = port.get_vulnerability(vulnerability_id)

            self.storage_port.save(vulnerability, vulnerability_id)

            if vulnerability:
                return vulnerability

        return None

    def get_affected_products(self, vulnerability: Vulnerability) -> List[Product]:
        affected_products = []

        for port in self.repository_ports:
            affected_products.extend(port.get_affected_products(vulnerability))

        return affected_products

    def get_vulnerabilities(self):
        # TODO: Implement this method
        pass
