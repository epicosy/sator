from typing import Dict, Iterator
from arepo.models import VulnerabilityModel, VulnerabilityCWEModel
from sator.core.adapters.base import BaseAdapter

from nvdutils.models.cve import CVE
from nvdutils.models.weaknesses import Weaknesses
from nvdutils.common.enums.weaknesses import WeaknessType


class VulnerabilityCWEAdapter(BaseAdapter):
    def __init__(self, cve_id: str, weaknesses: Weaknesses, cwe_ids: Dict[str, id], source: str = "nvd@nist.gov"):
        super().__init__()
        self.cve_id = cve_id
        self.weaknesses = weaknesses
        self.source = source
        self.cwe_ids = cwe_ids

    def __call__(self) -> Iterator[Dict[str, VulnerabilityCWEModel]]:
        # TODO: database needs to accommodate both types of weaknesses
        for weakness in self.weaknesses.get(weakness_type=WeaknessType.Primary, source=self.source):
            for cwe_id in weakness.ids:
                if cwe_id in self.cwe_ids:
                    _id = f"{self.cve_id}_{cwe_id}"
                    self._ids[VulnerabilityCWEModel.__tablename__].add(_id)
                    yield {
                        _id: VulnerabilityCWEModel(
                            vulnerability_id=self.cve_id,
                            cwe_id=cwe_id
                        )
                    }


class VulnerabilityAdapter(BaseAdapter):
    def __init__(self, cve: CVE):
        super().__init__()
        self.cve = cve

    def __call__(self) -> Dict[str, VulnerabilityModel]:
        self._ids[VulnerabilityModel.__tablename__].add(self.cve.id)
        return {
            self.cve.id: VulnerabilityModel(
                id=self.cve.id,
                description=self.cve.descriptions.get_eng_description().value,
                assigner=self.cve.source,
                severity=None, impact=None, exploitability=None,  # TODO: remove severity, impact, exploitability
                published_date=self.cve.published_date,
                last_modified_date=self.cve.last_modified_date
            )
        }
