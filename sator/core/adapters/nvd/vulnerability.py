from nvdutils.types.cve import CVE
from typing import Dict, Iterator, List
from nvdutils.types.weakness import WeaknessType
from arepo.models import VulnerabilityModel, VulnerabilityCWEModel
from sator.core.adapters.base import BaseAdapter


class VulnerabilityCWEAdapter(BaseAdapter):
    def __init__(self, cve: CVE, cwe_ids: List[int], source: str = "nvd@nist.gov"):
        super().__init__()
        self.cve = cve
        self.source = source
        self.cwe_ids = cwe_ids

    def __call__(self) -> Iterator[Dict[str, VulnerabilityCWEModel]]:
        # TODO: database needs to accommodate both types of weaknesses
        for weakness in self.cve.get_weaknesses(weakness_type=WeaknessType.Primary, source=self.source):
            for cwe_id in weakness.get_numeric_values():
                if cwe_id in self.cwe_ids:
                    cwe_assoc = VulnerabilityCWEModel(vulnerability_id=self.cve.id, cwe_id=cwe_id)
                    yield from self.yield_if_new(cwe_assoc, VulnerabilityCWEModel.__tablename__)


class VulnerabilityAdapter(BaseAdapter):
    def __init__(self, cve: CVE, source_ids: Dict[str, str]):
        super().__init__()
        self.cve = cve
        self.source_ids = source_ids

    def __call__(self) -> Dict[str, VulnerabilityModel]:
        # TODO: fix the source ids
        self._ids[VulnerabilityModel.__tablename__].add(self.cve.id)
        return {
            self.cve.id: VulnerabilityModel(
                id=self.cve.id,
                description=self.cve.get_eng_description().value,
                source_id="nvd_id",
                published_date=self.cve.published_date,
                last_modified_date=self.cve.last_modified_date
            )
        }
