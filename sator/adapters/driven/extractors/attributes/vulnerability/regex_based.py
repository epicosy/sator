import re

from sator.core.models.enums import DescriptionType
from sator.core.models.vulnerability.description import VulnerabilityDescription
from sator.core.ports.driven.extraction.attributes.vulnerability import VulnerabilityAttributesExtractorPort


# ------------------- 8 Key Phrasing Details -------------
# weakness function file product version attacker impact vector
DETAILS_8_1 = (r'(?P<weakness>.+?) in (the |)(?P<function>.+?) function in (?P<file>.+?) in (?P<product>.+?) '
               r'(?P<version>.+?) allow(s|ed|ing|) (?P<attacker>.+?) to (?P<impact>.+?) (via|by) (vector[s]? |)'
               r'(?P<vector>.+)')

# TODO: add more regex templates


class RegexVulnerabilityAttributesExtractor(VulnerabilityAttributesExtractorPort):
    def extract_vulnerability_attributes(self, vulnerability_description: VulnerabilityDescription) -> dict | None:
        if vulnerability_description.description_type == DescriptionType.CVE:
            match = re.compile(DETAILS_8_1).match(vulnerability_description.content)

            if match:
                return match.groupdict()

        return None
