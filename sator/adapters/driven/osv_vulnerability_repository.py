from typing import Dict, Any, List

from sator.core.models.vulnerability import Vulnerability
from sator.core.ports.driven.vulnerability_repository import VulnerabilityRepositoryPort

from osvutils.types.osv import OSV
from osvutils.core.loader import OSVDataLoader
from osvutils.core.filters.loader import LoaderFilters
from osvutils.core.filters.database import DatabaseFilter
from osvutils.core.filters.affected_packages import AffectedPackagesFilter


class OSVVulnerabilityMapper:
    @staticmethod
    def map_osv_vulnerability(osv: OSV) -> Vulnerability:
        return Vulnerability(
            id=osv.id,
            assigner="opensource@google.com",
            description=OSVVulnerabilityMapper.get_description(osv),
            published_date=osv.published
        )

    @staticmethod
    def get_description(osv: OSV) -> str:
        if osv.details:
            return osv.details
        elif osv.summary:
            return osv.summary
        else:
            return ""


class OSVVulnerabilityRepository(VulnerabilityRepositoryPort):
    def __init__(self):
        # TODO: temporary solution to load the data
        self.loader = OSVDataLoader(
            ecosystems=["GIT"],
            filters=LoaderFilters(
                database_filter=DatabaseFilter(
                    prefix_is_cve=True
                ),
                affected_packages_filter=AffectedPackagesFilter(
                    has_git_ranges=True
                )
            )
        )
        # TODO: osv-utils must provide a way retrieve the data in a dictionary
        self.loader()

    def get_vulnerability(self, vulnerability_id: str) -> Vulnerability | None:
        # TODO: osv-utils must provide a better way to search for the vulnerability
        for ecosystem, records in self.loader:
            for _id, osv in records.items():
                if _id == vulnerability_id:
                    return OSVVulnerabilityMapper.map_osv_vulnerability(osv)
                if osv.aliases:
                    for alias in osv.aliases:
                        if alias.value == vulnerability_id:
                            return OSVVulnerabilityMapper.map_osv_vulnerability(osv)

        return None

    def get_vulnerabilities(self, filters: Dict[str, Any] = None) -> List[Vulnerability]:
        return [OSVVulnerabilityMapper.map_osv_vulnerability(osv) for _, records in self.loader for osv in records]
