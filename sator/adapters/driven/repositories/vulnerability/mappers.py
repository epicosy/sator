from typing import List
from datetime import datetime

from osvutils.types.osv import OSV
from nvdutils.models.cve import CVE
from nvdutils.models.configurations.node import CPEPart

from sator.core.models.product import Product
from sator.core.models.enums import ProductPart
from sator.core.models.vulnerability import Vulnerability


# TODO: decide if this is still needed
OSV_TO_NVD_TAG_MAP = {
    'ADVISORY': 'Vendor Advisory',
    'ARTICLE': 'Third Party Advisory',  # (close enough)
    'DETECTION': 'Tool Signature',
    'DISCUSSION': 'Press/Media Coverage',
    'REPORT': 'Technical Description',
    'FIX': 'Patch',
    'INTRODUCED': 'Issue Tracking',  # this should actually be a type of tag
    'PACKAGE': 'Product',
    'EVIDENCE': 'Exploit',
    'WEB': 'Other'
}


NVD_PRODUCT_PART_MAP = {
    CPEPart.Application: ProductPart.APPLICATION,
    CPEPart.Hardware: ProductPart.HARDWARE,
    CPEPart.OS: ProductPart.OPERATING_SYSTEM,
}


class NVDVulnerabilityMapper:
    @staticmethod
    def map_vulnerability(cve: CVE) -> Vulnerability:
        # TODO: temporary solution to get the reported_date from the cve-id
        year = datetime.strptime(cve.id.split("-")[1], "%Y")

        return Vulnerability(
            id=cve.id,
            assigner=cve.source,
            description=cve.descriptions.get_eng_description().value,
            reported_date=year,
            published_date=cve.published_date
        )

    @staticmethod
    def map_products(cve: CVE) -> List[Product]:
        affected_products = []

        for p in cve.configurations.vulnerable_products:
            product = Product(name=p.name, vendor=p.vendor)
            affected_products.append(product)

        return affected_products


class OSVVulnerabilityMapper:
    @staticmethod
    def map_osv_vulnerability(osv: OSV) -> Vulnerability:
        cve_id = osv.get_cve_id()

        # TODO: temporary solution to get reported_date
        if cve_id:
            year = datetime.strptime(cve_id.split("-")[1], "%Y")
        else:
            year = osv.published.year

        return Vulnerability(
            id=osv.id,
            assigner="opensource@google.com",
            description=OSVVulnerabilityMapper.get_description(osv),
            reported_date=year,
            published_date=osv.published
        )

    @staticmethod
    def get_description(osv: OSV) -> str:
        if osv.details:
            return osv.details
        elif osv.summary:
            return osv.summary
        else:
            return ""
