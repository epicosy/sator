from typing import List

from sator.core.models.product import Product
from sator.core.models.vulnerability.description import VulnerabilityDescription
from sator.core.models.vulnerability.metadata import VulnerabilityMetadata
from sator.core.ports.driven.repositories.vulnerability import VulnerabilityRepositoryPort
from sator.adapters.driven.repositories.vulnerability.mappers import OSVVulnerabilityMapper

from osvutils.core.loader import OSVDataLoader
from osvutils.core.filters.loader import LoaderFilters
from osvutils.core.filters.database import DatabaseFilter
from osvutils.core.filters.affected_packages import AffectedPackagesFilter


class OSVVulnerabilityRepository(VulnerabilityRepositoryPort):
    def __init__(self):
        # TODO: temporary solution to load the data
        self.loader = OSVDataLoader(
            ecosystems=["GIT"],
            filters=LoaderFilters(
                database_filter=DatabaseFilter(
                    prefix_is_cve=True
                ),
                affected_packages_filter=AffectedPackagesFilter(
                    has_git_ranges=True
                )
            )
        )
        # TODO: osv-utils must provide a way retrieve the data in a dictionary
        self.loader()

    def get_metadata(self, vulnerability_id: str) -> VulnerabilityMetadata | None:
        # TODO: osv-utils must provide a better way to search for the vulnerability
        for ecosystem, records in self.loader:
            for _id, osv in records.items():
                if _id == vulnerability_id:
                    return OSVVulnerabilityMapper.map_osv_vulnerability(osv)
                if osv.aliases:
                    for alias in osv.aliases:
                        if alias.value == vulnerability_id:
                            return OSVVulnerabilityMapper.map_osv_vulnerability(osv)

        return None

    def get_description(self, vulnerability_id: str) -> VulnerabilityDescription | None:
        # TODO: refactor this method to avoid code duplication
        for ecosystem, records in self.loader:
            for _id, osv in records.items():
                if _id == vulnerability_id:
                    return OSVVulnerabilityMapper.map_description(osv)
                if osv.aliases:
                    for alias in osv.aliases:
                        if alias.value == vulnerability_id:
                            return OSVVulnerabilityMapper.map_description(osv)

        return None

    def get_affected_products(self, vulnerability: VulnerabilityMetadata) -> List[Product]:
        # TODO: Implement this method
        return []

    def get_references(self, vulnerability: VulnerabilityMetadata) -> List[str]:
        # TODO: Implement this method
        pass
