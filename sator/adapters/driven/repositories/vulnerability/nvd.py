from typing import List
from pathlib import Path

from sator.core.models.product import Product
from sator.core.models.vulnerability import VulnerabilityMetadata, VulnerabilityReferences, VulnerabilityDescription

from sator.core.ports.driven.repositories.vulnerability import VulnerabilityRepositoryPort
from sator.adapters.driven.repositories.vulnerability.mappers import NVDVulnerabilityMapper


from nvdutils.common.enums.cve import TagType
from nvdutils.loaders.json.default import JSONDefaultLoader
from nvdutils.data.profiles.zero_click import ZeroClickProfile


class NVDVulnerabilityRepository(VulnerabilityRepositoryPort):
    def __init__(self, path: str = "~/.nvdutils/nvd-json-data-feeds"):
        # TODO: temporary solution to load the entire CVE dictionary for the ZeroClickProfile
        self.loader = JSONDefaultLoader(profile=ZeroClickProfile)
        self.path = Path(path).expanduser()

    def get_metadata(self, vulnerability_id: str) -> VulnerabilityMetadata | None:
        cve = self.loader.load_by_id(vulnerability_id, self.path)

        if cve:
            return NVDVulnerabilityMapper.map_vulnerability(cve)

        return None

    def get_description(self, vulnerability_id: str) -> VulnerabilityDescription | None:
        cve = self.loader.load_by_id(vulnerability_id, self.path)

        if cve:
            return NVDVulnerabilityMapper.map_description(cve)

        return None

    def get_affected_products(self, vulnerability: VulnerabilityMetadata) -> List[Product]:
        cve = self.loader.load_by_id(vulnerability.id, self.path)

        if cve:
            return NVDVulnerabilityMapper.map_products(cve)

        return []

    def get_references(self, vulnerability_id: str) -> VulnerabilityReferences | None:
        cve = self.loader.load_by_id(vulnerability_id, self.path)

        if not cve:
            return None

        references = VulnerabilityReferences()

        # Define a mapping of tag types to reference categories
        tag_to_category = {
            TagType.Patch: references.patches,
            TagType.Product: references.product,
            TagType.Exploit: references.exploits,
            TagType.VendorAdvisory: references.advisories,
            TagType.ThirdPartyAdvisory: references.advisories,
            TagType.TechnicalDescription: references.reports,
            TagType.USGovernmentResource: references.reports
        }

        visited = set()

        for reference in cve.references:
            if reference.url in visited:
                continue

            if TagType.BrokenLink in reference.tags or TagType.PermissionsRequired in reference.tags:
                continue

            intersection = set(reference.tags).intersection(tag_to_category.keys())

            if intersection:
                if TagType.Patch in intersection:
                    # TODO: find a better to do this
                    tag = TagType.Patch
                else:
                    tag = intersection.pop()

                tag_to_category[tag].append(reference.url)
            else:
                references.other.append(reference.url)

            visited.add(reference.url)

        return references
