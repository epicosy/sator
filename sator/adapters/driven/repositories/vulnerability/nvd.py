from pathlib import Path
from typing import Dict, Any, List

from sator.core.models.product import Product
from sator.core.models.vulnerability import Vulnerability
from sator.core.ports.driven.repositories.vulnerability import VulnerabilityRepositoryPort
from sator.adapters.driven.repositories.vulnerability.mappers import NVDVulnerabilityMapper


from nvdutils.loaders.json.default import JSONDefaultLoader
from nvdutils.data.profiles.zero_click import ZeroClickProfile


class NVDVulnerabilityRepository(VulnerabilityRepositoryPort):
    def __init__(self, path: str = "~/.nvdutils/nvd-json-data-feeds"):
        # TODO: temporary solution to load the entire CVE dictionary for the ZeroClickProfile
        self.loader = JSONDefaultLoader(profile=ZeroClickProfile)
        self.path = Path(path).expanduser()

    def get_vulnerability(self, vulnerability_id: str) -> Vulnerability | None:
        cve = self.loader.load_by_id(vulnerability_id, self.path)

        if cve:
            return NVDVulnerabilityMapper.map_vulnerability(cve)

        return None

    def get_vulnerabilities(self, filters: Dict[str, Any] = None) -> List[Vulnerability]:
        cve_dict = self.loader.load(self.path, include_subdirectories=True)

        return list(
            filter(None, [NVDVulnerabilityMapper.map_vulnerability(cve) for cve in cve_dict])
        )

    def get_affected_products(self, vulnerability: Vulnerability) -> List[Product]:
        cve = self.loader.load_by_id(vulnerability.id, self.path)

        if cve:
            return NVDVulnerabilityMapper.map_products(cve)

        return []

    def get_references(self, vulnerability: Vulnerability) -> List[str]:
        cve = self.loader.load_by_id(vulnerability.id, self.path)

        if cve:
            return [str(ref.url) for ref in cve.references]

        return []
