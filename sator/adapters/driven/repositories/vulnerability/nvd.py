from pathlib import Path
from typing import Dict, Any, List

from sator.core.models.vulnerability import Vulnerability
from sator.core.ports.driven.vulnerability_repository import VulnerabilityRepositoryPort

from nvdutils.loaders.json.default import JSONDefaultLoader
from nvdutils.data.profiles.zero_click import ZeroClickProfile
from nvdutils.models.cve import CVE


class NVDVulnerabilityMapper:
    @staticmethod
    def map_nvd_vulnerability(cve: CVE) -> Vulnerability:
        return Vulnerability(
            id=cve.id,
            assigner=cve.source,
            description=cve.descriptions.get_eng_description().value,
            published_date=cve.published_date
        )


class NVDVulnerabilityRepository(VulnerabilityRepositoryPort):
    def __init__(self, path: str = "~/.nvdutils/nvd-json-data-feeds"):
        # TODO: temporary solution to load the entire CVE dictionary for the ZeroClickProfile
        self.loader = JSONDefaultLoader(profile=ZeroClickProfile)
        self.cve_dict = self.loader.load(Path(path), include_subdirectories=True)

    def get_vulnerability(self, vulnerability_id: str) -> Vulnerability | None:
        # TODO: nvdutils needs to implement a get method to directly access the CVE without loading the entire dict
        nvd_vulnerability = self.cve_dict.entries.get(vulnerability_id, None)

        if nvd_vulnerability:
            return NVDVulnerabilityMapper.map_nvd_vulnerability(nvd_vulnerability)

    def get_vulnerabilities(self, filters: Dict[str, Any] = None) -> List[Vulnerability]:
        return list(
            filter(None, [NVDVulnerabilityMapper.map_nvd_vulnerability(cve) for cve in self.cve_dict])
        )
