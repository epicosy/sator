from typing import List
from pathlib import Path

from sator.core.models.product import Product
from sator.core.models.vulnerability.metadata import VulnerabilityMetadata
from sator.core.models.vulnerability.description import VulnerabilityDescription

from sator.core.ports.driven.repositories.vulnerability import VulnerabilityRepositoryPort
from sator.adapters.driven.repositories.vulnerability.mappers import NVDVulnerabilityMapper


from nvdutils.loaders.json.default import JSONDefaultLoader
from nvdutils.data.profiles.zero_click import ZeroClickProfile


class NVDVulnerabilityRepository(VulnerabilityRepositoryPort):
    def __init__(self, path: str = "~/.nvdutils/nvd-json-data-feeds"):
        # TODO: temporary solution to load the entire CVE dictionary for the ZeroClickProfile
        self.loader = JSONDefaultLoader(profile=ZeroClickProfile)
        self.path = Path(path).expanduser()

    def get_metadata(self, vulnerability_id: str) -> VulnerabilityMetadata | None:
        cve = self.loader.load_by_id(vulnerability_id, self.path)

        if cve:
            return NVDVulnerabilityMapper.map_vulnerability(cve)

        return None

    def get_description(self, vulnerability_id: str) -> VulnerabilityDescription | None:
        cve = self.loader.load_by_id(vulnerability_id, self.path)

        if cve:
            return NVDVulnerabilityMapper.map_description(cve)

        return None

    def get_affected_products(self, vulnerability: VulnerabilityMetadata) -> List[Product]:
        cve = self.loader.load_by_id(vulnerability.id, self.path)

        if cve:
            return NVDVulnerabilityMapper.map_products(cve)

        return []

    def get_references(self, vulnerability: VulnerabilityMetadata) -> List[str]:
        cve = self.loader.load_by_id(vulnerability.id, self.path)

        if cve:
            return [str(ref.url) for ref in cve.references]

        return []
